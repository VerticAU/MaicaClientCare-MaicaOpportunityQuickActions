<aura:component description="NDISProductManagementScheduleModal" extends="c:aura_Modal" access="public">

    <!-- ATTRIBUTES -->
    <aura:attribute name="item" type="Map" access="public"/>
    <aura:attribute name="index" type="Integer" access="public"/>
    <aura:attribute name="filter" type="Map" default="{}"/>
    <aura:attribute name="enforceHolidaysByState" type="Boolean" default="true"/>
    <aura:attribute name="activeSections" type="List" default="['availableItems', 'schedule']"/>
    <aura:attribute name="typeOptions" type="List" default='[{"label":"Support Item","value":"Item"},{"label":"Support Category","value":"Category"}]'/>

    <!-- HANDLERS -->
    <aura:handler name="init" value="{!this}" action="{!c.handleInit}"/>
    <aura:handler name="change" value="{!v.filter}" action="{!c.handleFilterChange}"/>
    <aura:handler name="change" value="{!v.item.Service_Time__c}" action="{!c.handleServiceTimeChange}"/>
    <aura:handler name="change" value="{!v.item.Service_Day__c}" action="{!c.handleServiceDayChange}"/>
    <aura:handler name="change" value="{!v.item.Schedule_Day__c}" action="{!c.handleScheduleDayChange}"/>
    <aura:handler name="change" value="{!v.item.Service_Frequency__c}" action="{!c.handleServiceFrequencyChange}"/>

    <lightning:notificationsLibrary aura:id="notifLib"/>

    <aura:html tag="style">
        .slds-modal__container {
        width: 100% !important;
        max-width: 80rem !important;
        }
    </aura:html>

    <aura:attribute name="schedule" type="Aura.Component[]">

        <div class="slds-grid slds-gutters slds-m-bottom_medium">
            <div class="slds-col slds-size_1-of-12">
                <p class="slds-p-top_x-small">
                    Funding Structure
                    <lightning:helptext iconName="utility:info_alt"
                                        content="Indicates the funding structure.  Item allows you to configure funding for a specific Product, whereas Category allows you to setup bucket funding for a Support Category."
                                        style="position: relative;top: -4px;"
                    />
                </p>
            </div>
            <div class="slds-col slds-size_5-of-12">
                <lightning:radioGroup label="Period"
                                      value="{!v.item.type}"
                                      type="button"
                                      variant="label-hidden"
                                      options="{!v.typeOptions}"
                                      required="{!true}"
                                      style="min-width: 314px"
                                      onchange="{!c.handleItemTypeChange}"
                />
            </div>
        </div>

        <div class="slds-grid slds-gutters slds-m-bottom_medium">
            <div class="slds-col slds-size_1-of-12">
                <p class="slds-p-top_x-small">
                    Period
                    <lightning:helptext iconName="utility:info_alt"
                                        content="Indicates the date range the funding is valid for."
                                        style="position: relative;top: -5px;"
                    />
                </p>
            </div>
            <div class="slds-col slds-size_5-of-12">
                <lightning:radioGroup label="Period"
                                      value="{!v.item.Period_Type__c}"
                                      type="button"
                                      variant="label-hidden"
                                      options="{!v.meta.selectOptions.periodTypeOptions}"
                                      required="{!true}"
                                      style="min-width: 314px"
                                      onchange="{!c.handlePeriodChange}"
                />
            </div>
        </div>

        <div class="slds-grid slds-gutters slds-m-bottom_medium">
            <div class="slds-col  slds-size_1-of-12">
                <p class="slds-p-top_x-small">
                    Start Date
                </p>
            </div>
            <div class="slds-col  slds-size_5-of-12 slds-text-align_left">
                <lightning:input type="date"
                                 label="Start Date"
                                 value="{!v.item.Start_Date__c}"
                                 autocomplete="false"
                                 required="{!true}"
                                 disabled="{!or(v.isBusy, not(or(empty(v.item.Period_Type__c), v.item.Period_Type__c == 'Custom')))}"
                                 onchange="{!c.handleScheduleChange}"
                                 class="slds-show_inline"
                                 variant="label-hidden"
                                 style="max-width: 314px"
                                 min="{!if(v.meta.dto.isEnforceActivePlan == true, v.meta.dto.activePlan.maica_cc__Start_Date__c, null)}"
                                 messageWhenRangeUnderflow="{!'Active Plan Enforced. The Start Date must be ' + v.meta.dto.activePlanStartDateFormatted + ' or later'}"
                                 aura:id="itemStartDate"
                />
            </div>
            <div class="slds-col slds-size_1-of-12">
                <p class="slds-p-top_x-small">
                    End Date
                </p>
            </div>
            <div class="slds-col slds-size_5-of-12">

                <lightning:input type="date"
                                 label="End Date"
                                 value="{!v.item.End_Date__c}"
                                 onchange="{!c.handleScheduleChange}"
                                 autocomplete="false"
                                 disabled="{!or(v.isBusy, not(or(empty(v.item.Period_Type__c), v.item.Period_Type__c == 'Custom')))}"
                                 required="{!true}"
                                 class="slds-show_inline"
                                 variant="label-hidden"
                                 style="max-width: 314px"
                                 max="{!if(v.meta.dto.isEnforceActivePlan == true, v.meta.dto.activePlan.maica_cc__End_Date__c, null)}"
                                 messageWhenRangeOverflow="{!'Active Plan Enforced. The End Date must be ' + v.meta.dto.activePlanEndDateFormatted + ' or lower'}"
                                 aura:id="itemEndDate"
                />

            </div>
        </div>

        <aura:if isTrue="{!v.item.type == 'Category'}">

            <div class="slds-grid slds-gutters slds-m-bottom_medium slds-grid_vertical-align-start">
                <div class="slds-col slds-size_1-of-12">
                    <p class="slds-p-top_x-small">Amount</p>
                </div>
                <div class="slds-col slds-size_5-of-12">
                    <div style="width: 40%">
                        <lightning:input label="Amount"
                                         value="{!v.item.UnitPrice}"
                                         type="number"
                                         step="0.01"
                                         min="0"
                                         variant="label-hidden"
                                         required="{!true}"
                        />
                    </div>
                </div>
            </div>

            <aura:set attribute="else">
                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <div class="slds-col slds-size_1-of-12">
                        <p class="slds-p-top_x-small">
                            Service Day
                            <lightning:helptext iconName="utility:info_alt"
                                                content="Set the days of the week the Client has nominated to receive the Product/Service."
                                                style="position: relative;top: -19px;left: 74px;"
                            />
                        </p>
                    </div>
                    <div class="slds-col slds-size_5-of-12">
                        <lightning:radioGroup label="Service Day"
                                              value="{!v.item.Service_Day__c}"
                                              type="button"
                                              variant="label-hidden"
                                              options="{!v.meta.selectOptions.serviceDayOptions}"
                                              required="{!true}"
                        />
                    </div>

                    <div class="slds-col slds-size_1-of-12">
                        <p class="slds-p-top_x-small">
                            Service Time
                            <lightning:helptext iconName="utility:info_alt"
                                                content="Set the time of day the Client has nominated to receive the Product/Service."
                                                style="position: relative;top: -19px;left: 81px;"
                            />
                        </p>
                    </div>
                    <div class="slds-col slds-size_5-of-12">
                        <lightning:radioGroup label="Service Time"
                                              value="{!v.item.Service_Time__c}"
                                              type="button"
                                              variant="label-hidden"
                                              options="{!v.meta.selectOptions.serviceTimeOptions}"
                                              required="{!true}"
                                              onchange="{!c.handleFilterChange}"
                        />
                    </div>
                </div>

                <div class="slds-grid slds-gutters slds-m-bottom_medium">
                    <div class="slds-col slds-size_1-of-12">
                        <p>
                            Service Frequency
                            <lightning:helptext iconName="utility:info_alt"
                                                content="Set the frequency or interval the Client has nominated to receive the Product/Service.  Used to calculate the Quantity."
                                                style="position: relative;top: -20px;left: 66px;"
                            />
                        </p>
                    </div>
                    <div class="slds-col slds-size_5-of-12 slds-modal_large">
                        <aura:if isTrue="{!v.item.Service_Day__c != 'Public Holiday'}">
                            <lightning:radioGroup label="Service Frequency"
                                                  value="{!v.item.Service_Frequency__c}"
                                                  type="button"
                                                  variant="label-hidden"
                                                  options="{!if(or(v.item.Service_Day__c == 'Sunday', or(v.item.Service_Day__c == 'Saturday', v.item.Service_Day__c == 'Weekday')), v.meta.selectOptions.serviceFrequencyWithoutDailyAndPublicHolidayOptions, v.meta.selectOptions.serviceFrequencyWithoutPublicHolidayOptions)}"
                                                  required="{!true}"
                                                  disabled="{!v.isBusy}"
                                                  style="min-width: 314px"
                            />
                            <aura:set attribute="else">
                                <div class="slds-p-top_x-small">
                                    {!v.item.Service_Day__c}. (You can manage Holidays list <a href="/lightning/setup/Holiday/home" target="_blank">here</a>.)
                                </div>
                            </aura:set>
                        </aura:if>
                    </div>

                    <aura:if isTrue="{!v.item.Service_Day__c == 'Public Holiday'}">
                        <div class="slds-col slds-size_3-of-12">
                            <lightning:input label="Enforce Public Holidays by State"
                                             type="checkbox"
                                             checked="{!v.enforceHolidaysByState}"
                                             onchange="{!c.handleScheduleChange}"
                            />
                        </div>
                    </aura:if>
                    <aura:if
                            isTrue="{!and(not(empty(v.item.Service_Frequency__c)), and(v.item.Service_Frequency__c != 'One', v.item.Service_Frequency__c != 'Public Holiday'))}">
                        <div class="slds-col slds-size_1-of-12">
                            <p class="slds-p-top_x-small">Repeat Every</p>
                        </div>
                        <div class="slds-col slds-size_5-of-12">
                            <div class="slds-show_inline-block" style="max-width: 50px">
                                <lightning:input label="Repeat Every"
                                                 value="{!v.item.Schedule_Count__c}"
                                                 type="number"
                                                 step="1"
                                                 min="1"
                                                 variant="label-hidden"
                                                 onchange="{!c.handleScheduleChange}"
                                                 disabled="{!v.isBusy}"
                                                 required="{!true}"
                                                 class="slds-show_inline-block repeat"
                                />
                            </div>
                            <span class="slds-p-left_small">{!v.item.Service_Frequency__c}(s)</span>
                        </div>
                    </aura:if>
                </div>

                <aura:if isTrue="{!and(v.item.Service_Frequency__c == 'Week', or(v.item.Service_Day__c == 'Weekday', v.item.Service_Day__c == 'Anytime'))}">
                    <div class="slds-grid slds-gutters slds-m-bottom_medium">
                        <div class="slds-col slds-size_1-of-12">
                            <p>
                                Days of the Week
                                <lightning:helptext iconName="utility:info_alt"
                                                    content="Multi-select to set the specific days of the week the Client has nominated to receive the Product/Service.  Used to calculate the Quantity."
                                                    style="position: relative;top: -4px;"
                                />
                            </p>
                        </div>
                        <div class="slds-col slds-size_5-of-12">
                            <c:aura_ButtonGroupSelect label="Days of the Week"
                                                      value="{!v.item.Schedule_Day__c}"
                                                      options="{!if(v.item.Service_Day__c == 'Weekday', v.meta.selectOptions.weekdayOptions,v.meta.selectOptions.maicaScheduleDayOptions)}"
                                                      disabled="{!v.isBusy}"
                                                      required="{!true}"
                            />
                        </div>
                    </div>
                </aura:if>

                <div class="slds-grid slds-gutters slds-m-bottom_medium slds-grid_vertical-align-start">
                    <div class="slds-col slds-size_1-of-12">
                        <p class="slds-p-top_x-small">Quantity</p>
                    </div>
                    <div class="slds-col slds-size_5-of-12">
                        <div style="width: 40%">
                            <lightning:input label="Quantity"
                                             value="{!v.item.Service_Duration__c}"
                                             type="number"
                                             step="0.01"
                                             min="0"
                                             variant="label-hidden"
                                             required="{!true}"
                                             onchange="{!c.handleScheduleChange}"
                            />
                        </div>
                    </div>
                </div>
            </aura:set>
        </aura:if>

    </aura:attribute>

    <aura:attribute name="scheduleQuantity" type="Aura.Component[]">
        <div style="height: 30px">
            <c:aura_Processor aura:id="quantityCalcProcessor" isBusy="{!v.meta.isBusy}" response="{!v.meta.quantityCalcResponse}">
                <aura:set attribute="initial"></aura:set>
                <aura:set attribute="pending">
                    <lightning:icon iconName="utility:sync" class="slds-show_inline" size="x-small"/>
                </aura:set>
                <aura:set attribute="success">
                    Total Quantity:
                    <lightning:badge label="{!v.item.Quantity}"/>
                </aura:set>
                <aura:set attribute="failure">
                    <lightning:helptext iconVariant="error"
                                        class="slds-show_inline"
                                        size="x-small"
                                        content="{!v.meta.quantityCalcResponse.dto.error}"
                    />
                </aura:set>
            </c:aura_Processor>
        </div>
    </aura:attribute>

    <aura:attribute name="availableItems" type="Aura.Component[]">
        <lightning:card title="" class="slds-card_boundary">

            <div class="slds-m-horizontal_small">
                <div class="slds-grid slds-gutters slds-m-bottom--medium">
                    <div class="slds-col">
                        <c:aura_Lookup label="Support Category"
                                       object="maica_cc__Support_Category__c"
                                       searchField="Name"
                                       subtitleField="maica_cc__Short_Name__c"
                                       placeholder="Type to search by Support Category..."
                                       iconName="custom:custom71"
                                       order="Name"
                                       limit="10"
                                       errorMessage="Invalid input"
                                       showRecentRecords="{!true}"
                                       disabled="{!v.isBusy}"
                                       value="{!v.filter.supportCategoryId}"
                        />
                    </div>
                    <aura:if isTrue="{!v.item.type != 'Category'}">
                        <div class="slds-col">
                            <lightning:input label="Support Item Name (Support Item Number)"
                                             value="{!v.filter.supportItemName}"
                                             placeholder="Type to search by Support Item Name or Support Item Number..."
                                             disabled="{!v.isBusy}"
                                             type="search"
                            />
                        </div>
                    </aura:if>
                </div>

                <div class="slds-grid slds-gutters slds-m-bottom--medium" style="min-height: 340px;">
                    <div class="slds-col">

                        <c:aura_Processor aura:id="availableItemProcessor" isBusy="{!v.meta.isBusy}" response="{!v.meta.availableItemsResponse}">
                            <aura:set attribute="initial">
                                <p class="slds-text-title slds-text-align_center">Please select Start Date to search for available Support Items</p>
                            </aura:set>
                            <aura:set attribute="pending">
                                <p>
                                    <lightning:icon iconName="utility:sync" class="slds-show_inline" size="x-small"/>
                                </p>
                            </aura:set>
                            <aura:set attribute="success">

                                <aura:if isTrue="{!v.meta.availableItemsResponse.dto.items.records.length == 0}">
                                    <p class="slds-text-title slds-text-align_center">No available Support Items</p>

                                    <aura:set attribute="else">

                                        <aura:if isTrue="{!v.item.type == 'Category'}">
                                            <table class="slds-table slds-no-row-hover slds-table_fixed-layout">

                                                <thead>
                                                <tr class="slds-line-height_reset">
                                                    <th class="" scope="col" style="width: 5%;">
                                                        <div class="slds-truncate"></div>
                                                    </th>
                                                    <th class="" scope="col" style="width: 20%;">
                                                        <div class="slds-truncate">Category Number</div>
                                                    </th>
                                                    <th class="" scope="col" style="width: 55%">
                                                        <div class="slds-truncate">Category Name</div>
                                                    </th>
                                                    <th class="" scope="col" style="width: 20%;">
                                                        <div class="slds-truncate">Support Purpose</div>
                                                    </th>
                                                </tr>
                                                </thead>

                                                <tbody>
                                                <aura:iteration items="{!v.meta.availableItemsResponse.dto.items.records}" var="item" indexVar="index">
                                                    <tr class="slds-line-height_reset">
                                                        <td role="gridcell" scope="col">
                                                            <div class="slds-truncate slds-text-align_right" scope="col">
                                                                <aura:if isTrue="{!item.Product2.Favourite__c == true}">
                                                                    <lightning:icon size="x-small" iconName="utility:favorite"
                                                                                    class="slds-float_right favorite"
                                                                                    title="Favorite"
                                                                                    variant="warning"
                                                                    />
                                                                </aura:if>

                                                                <aura:if isTrue="{!not(empty(v.index))}">

                                                                    <lightning:input label="Selected"
                                                                                     type="radio"
                                                                                     name="selection"
                                                                                     value="{!index}"
                                                                                     variant="label-hidden"
                                                                                     class="slds-m-left_medium slds-show_inline"
                                                                                     onchange="{!c.handleRadioClick}"
                                                                    />

                                                                    <aura:set attribute="else">
                                                                        <lightning:input label="Selected"
                                                                                         type="checkbox"
                                                                                         checked="{!item.isSelected}"
                                                                                         variant="label-hidden"
                                                                                         class="slds-m-left_medium slds-show_inline"
                                                                        />
                                                                    </aura:set>
                                                                </aura:if>
                                                            </div>
                                                        </td>
                                                        <td role="gridcell" class="slds-cell-wrap">
                                                            <div class="slds-truncate" scope="col" title="{!item.Product2.Support_Category__r.maica_cc__Category_Number__c}">
                                                                {!item.Product2.Support_Category__r.maica_cc__Category_Number__c}
                                                            </div>
                                                        </td>
                                                        <td role="gridcell" class="slds-cell-wrap">
                                                            <div class="slds-truncate" scope="col" title="{!item.Product2.Support_Category__r.Name}">
                                                                <a href="{!'/' + item.Product2.Id}" target="_blank">{!item.Product2.Support_Category__r.Name}</a>
                                                            </div>
                                                        </td>
                                                        <td role="gridcell" class="slds-cell-wrap">
                                                            <div class="slds-truncate" scope="col" title="{!item.Product2.Support_Category__r.maica_cc__Support_Purpose__c}">
                                                                {!item.Product2.Support_Category__r.maica_cc__Support_Purpose__c}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </aura:iteration>
                                                </tbody>
                                            </table>

                                            <aura:set attribute="else">
                                                <table class="slds-table slds-no-row-hover slds-table_fixed-layout">

                                                    <thead>
                                                    <tr class="slds-line-height_reset">
                                                        <th class="" scope="col" style="width: 5%;">
                                                            <div class="slds-truncate"></div>
                                                        </th>
                                                        <th class="" scope="col" style="width: 10%;">
                                                            <div class="slds-truncate">Support Category</div>
                                                        </th>
                                                        <th class="" scope="col" style="width: 50%">
                                                            <div class="slds-truncate">Support Item Name</div>
                                                        </th>
                                                        <th class="" scope="col" style="width: 15%;">
                                                            <div class="slds-truncate">Support Item Number</div>
                                                        </th>
                                                        <th class="" scope="col" style="width: 10%;">
                                                            <div class="slds-truncate">Unit</div>
                                                        </th>
                                                        <th class="" scope="col" style="width: 10%;">
                                                            <div class="slds-truncate">Rate</div>
                                                        </th>
                                                    </tr>
                                                    </thead>

                                                    <tbody>
                                                    <aura:iteration items="{!v.meta.availableItemsResponse.dto.items.records}" var="item" indexVar="index">
                                                        <tr class="slds-line-height_reset">
                                                            <td role="gridcell" scope="col">
                                                                <div class="slds-truncate slds-text-align_right" scope="col">
                                                                    <aura:if isTrue="{!item.Product2.Favourite__c == true}">
                                                                        <lightning:icon size="x-small" iconName="utility:favorite"
                                                                                        class="slds-float_right favorite"
                                                                                        title="Favorite"
                                                                                        variant="warning"
                                                                        />
                                                                    </aura:if>

                                                                    <aura:if isTrue="{!not(empty(v.index))}">

                                                                        <lightning:input label="Selected"
                                                                                         type="radio"
                                                                                         name="selection"
                                                                                         value="{!index}"
                                                                                         variant="label-hidden"
                                                                                         class="slds-m-left_medium slds-show_inline"
                                                                                         onchange="{!c.handleRadioClick}"
                                                                        />

                                                                        <aura:set attribute="else">
                                                                            <lightning:input label="Selected"
                                                                                             type="checkbox"
                                                                                             checked="{!item.isSelected}"
                                                                                             variant="label-hidden"
                                                                                             class="slds-m-left_medium slds-show_inline"
                                                                            />
                                                                        </aura:set>
                                                                    </aura:if>


                                                                </div>
                                                            </td>
                                                            <td role="gridcell" class="slds-cell-wrap">
                                                                <div class="slds-truncate" scope="col" title="{!item.Product2.Support_Category__r.maica_cc__Short_Name__c}">
                                                                    {!item.Product2.Support_Category__r.maica_cc__Short_Name__c}
                                                                </div>
                                                            </td>
                                                            <td role="gridcell" class="slds-cell-wrap">
                                                                <div class="slds-truncate" scope="col" title="{!item.Product2.Name}">
                                                                    <a href="{!'/' + item.Product2.Id}" target="_blank">{!item.Product2.Name}</a>
                                                                </div>
                                                            </td>
                                                            <td role="gridcell" class="slds-cell-wrap">
                                                                <div class="slds-truncate" scope="col" title="{!item.Product2.Support_Item_Number__c}">
                                                                    {!item.Product2.Support_Item_Number__c}
                                                                </div>
                                                            </td>
                                                            <td role="gridcell" class="slds-cell-wrap">
                                                                <div class="slds-truncate" scope="col" title="{!item.Product2.QuantityUnitOfMeasure}">
                                                                    {!item.Product2.QuantityUnitOfMeasure}
                                                                </div>
                                                            </td>
                                                            <td role="gridcell" class="slds-cell-wrap">
                                                                <div class="slds-truncate" scope="col" title="{!item.UnitPrice}">
                                                                    <lightning:formattedNumber value="{!item.UnitPrice}"
                                                                                               style="currency"
                                                                                               currencyDisplayAs="symbol"
                                                                    />
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </aura:iteration>
                                                    </tbody>
                                                </table>
                                            </aura:set>
                                        </aura:if>


                                        <aura:if isTrue="{!v.meta.availableItemsResponse.dto.items.hasMore}">
                                            <c:aura_ScopedNotification>
                                                The table shows up to {!v.meta.availableItemsResponse.dto.items.limit} records. There are more records available, please search by Support Item
                                                Name/Number.
                                            </c:aura_ScopedNotification>
                                        </aura:if>

                                    </aura:set>

                                </aura:if>

                            </aura:set>
                            <aura:set attribute="failure">
                                <lightning:helptext iconVariant="error"
                                                    class="slds-show_inline"
                                                    size="x-small"
                                                    content="{!v.meta.availableItemsResponse.dto.error}"
                                />
                            </aura:set>
                        </c:aura_Processor>

                    </div>
                </div>
            </div>
        </lightning:card>
    </aura:attribute>

    <div style="min-height: 600px">

        <c:aura_ScopedNotification theme="warning" isVisible="{!v.meta.quantityCalcResponse.showError == true}">
            This Product could not be added. This might be because the right Service Day/Time are not selected. Please check the Product details to make sure it is configured correctly.
        </c:aura_ScopedNotification>

        <lightning:accordion activeSectionName="{!v.activeSections}" allowMultipleSectionsOpen="{!true}">
            <lightning:accordionSection label="Structure" name="schedule">
                <aura:set attribute="actions">
                    {!v.scheduleQuantity}
                </aura:set>
                {!v.schedule}
            </lightning:accordionSection>

            <aura:if isTrue="{!not(empty(v.index))}">
                <lightning:accordionSection label="{!'Selected: ' + if(v.item.Product2Id, v.item.Product2.Name + ')', 'None')}">
                    <aura:set attribute="actions">
                        <aura:if isTrue="{!v.meta.quantityCalcResponse.dto.isItemValidForServiceDate == true}">
                            <lightning:helptext iconName="utility:success"
                                                class="slds-show_inline slds-icon-text-success"
                                                size="medium"
                                                content="This Product meets the Service Day/Time configuration."/>
                        </aura:if>
                        <aura:if isTrue="{!v.meta.quantityCalcResponse.dto.isItemValidForServiceDate == false}">
                            <lightning:helptext iconName="utility:warning"
                                                iconVariant="warning"
                                                size="medium"
                                                content="This Product could not be added. This might be because the right Service Day/Time are not selected. Please check the Product details to make sure it is configured correctly."/>
                        </aura:if>
                    </aura:set>

                    <div class="slds-m-horizontal_medium">
                        <div class="slds-grid slds-gutters_small slds-m-bottom_medium">

                            <div class="slds-col">
                                <p class="slds-form-element__label">Support Category</p>
                                <div class="slds-m-vertical_x-small1" style="font-size: 0.875rem">
                                    <a href="{!'/' + v.item.Product2.Support_Category__c}" target="_blank">
                                        {!v.item.Product2.Support_Category__r.Name}
                                    </a>
                                </div>
                            </div>

                            <aura:if isTrue="{!v.item.type != 'Category'}">
                                <div class="slds-col">
                                    <p class="slds-form-element__label">Name</p>
                                    <div class="slds-m-vertical_x-small1" style="font-size: 0.875rem">
                                        <a href="{!'/' + v.item.Product2Id}" target="_blank">
                                            {!v.item.Product2.Name}
                                        </a>
                                    </div>
                                </div>

                                <div class="slds-col">
                                    <p class="slds-form-element__label">Support Item Number</p>
                                    <div class="slds-m-vertical_x-small1" style="font-size: 0.875rem">
                                        {!v.item.Product2.Support_Item_Number__c}
                                    </div>
                                </div>
                            </aura:if>
                        </div>
                    </div>
                </lightning:accordionSection>
            </aura:if>

            <lightning:accordionSection label="Available Funding" name="availableItems">
                <aura:set attribute="actions">
                    <p style="min-height: 25px;">
                        <aura:if isTrue="{!not(empty(v.meta.availableItemsResponse.dto))}">
                            Total Items:
                            <lightning:badge label="{!'' + v.meta.availableItemsResponse.dto.items.records.length + if(v.meta.availableItemsResponse.dto.items.hasMore, '+', '')}"/>
                        </aura:if>
                    </p>
                </aura:set>
                {!v.availableItems}
            </lightning:accordionSection>
        </lightning:accordion>
    </div>

    <aura:set attribute="footer">
        <div class="slds-float_left" style="padding-top: 4px;">
            <aura:if isTrue="{!not(empty(v.meta.dto.activePlan))}">
                <a target="_blank" href="{!'/' + v.meta.dto.activePlan.Id}" style="position: relative;display: inline-block;top: 2px;">{!v.meta.dto.activePlan.Name}</a>
                <lightning:helptext content="Only allow the Products within the recorded Participant's Plan Details (Active Plan)"
                                    style="position: relative;top: -2px;left: 4px;"
                />
            </aura:if>

        </div>

        <lightning:button name="cancel" label="Cancel" onclick="{!c.handleCancelClick}" disabled="{!v.isBusy}"/>

        <aura:if isTrue="{!not(empty(v.index))}">
            <lightning:button name="save" label="Save" variant="brand" onclick="{!c.handleSaveClick}" disabled="{!v.isBusy}"/>
            <aura:set attribute="else">
                <lightning:button name="add" label="Add" variant="brand" onclick="{!c.handleAddClick}" disabled="{!v.isBusy}"/>
            </aura:set>
        </aura:if>
    </aura:set>
</aura:component>